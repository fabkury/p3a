# Update web flasher manifest when a new release is published
# This ensures the web flasher always points to the latest firmware

name: Update Web Flasher Manifest

on:
  release:
    types: [published]

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.5.4-dev)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          # Remove 'v' prefix if present for the manifest
          VERSION_CLEAN="${VERSION#v}"
          echo "version=$VERSION_CLEAN" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION_CLEAN (tag: $VERSION)"

      - name: Update manifest.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          
          # Update manifest.json with new version and URLs
          cat > docs/web-flasher/manifest.json << EOF
          {
            "name": "p3a Firmware",
            "version": "$VERSION",
            "home_assistant_domain": "",
            "funding_url": "",
            "new_install_prompt_erase": true,
            "builds": [
              {
                "chipFamily": "ESP32-P4",
                "parts": [
                  {
                    "path": "https://github.com/fabkury/p3a/releases/download/$TAG/bootloader.bin",
                    "offset": 8192
                  },
                  {
                    "path": "https://github.com/fabkury/p3a/releases/download/$TAG/partition-table.bin",
                    "offset": 32768
                  },
                  {
                    "path": "https://github.com/fabkury/p3a/releases/download/$TAG/ota_data_initial.bin",
                    "offset": 65536
                  },
                  {
                    "path": "https://github.com/fabkury/p3a/releases/download/$TAG/p3a.bin",
                    "offset": 131072
                  },
                  {
                    "path": "https://github.com/fabkury/p3a/releases/download/$TAG/storage.bin",
                    "offset": 16908288
                  },
                  {
                    "path": "https://github.com/fabkury/p3a/releases/download/$TAG/network_adapter.bin",
                    "offset": 17956864
                  }
                ]
              }
            ]
          }
          EOF
          
          echo "Updated manifest.json to version $VERSION"
          cat docs/web-flasher/manifest.json

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/web-flasher/manifest.json
          git diff --staged --quiet || git commit -m "Update web flasher manifest to ${{ steps.version.outputs.version }}"
          git push

