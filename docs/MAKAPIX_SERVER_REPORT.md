## Makapix Club – p3a device/server interaction report (2025-12-12)

This document is intended for the Makapix Club server team.

It has two parts:

1. **Detailed**: server-facing features implemented/changed today (playlist support + new request types/fields).
2. **Summarized**: all other currently-implemented p3a ↔ Makapix Club interactions (MQTT + HTTPS).

---

## Part 1 — New/changed server-facing features implemented today (detailed)

### 1.1 Transport model for API calls (MQTT request/response)

p3a uses MQTT as a request/response transport for Makapix “API” operations.

#### MQTT topics

- **Request publish**: `makapix/player/<player_key>/request/<request_id>`
  - QoS: **1**
- **Response subscribe**: `makapix/player/<player_key>/response/#`
  - p3a requires this subscription to be **SUBACK-confirmed** before it sends requests.

#### Correlation requirements

p3a correlates responses **by JSON field**:

- Every response payload must include:
  - `"request_id": "<same request_id as request>"`

The response topic name is not parsed for the request_id (only the prefix `.../response/` is used to route to the response handler).

#### Timeouts/retries (p3a expectation)

- p3a retries each MQTT API request up to **3 attempts**.
- It waits up to **30s** for a response per attempt.
- It uses exponential backoff between attempts (starting at 1s; capped).

#### Payload size expectations (important)

p3a’s MQTT client reassembles fragmented inbound MQTT payloads into a fixed buffer of **128 KiB** (131072 bytes).

- Responses that exceed ~128 KiB may be **truncated**, causing JSON parse failure.
- p3a prefers to allocate MQTT payload buffers from **PSRAM**; it will fall back to internal heap if PSRAM allocation fails (and logs this).
- Duplicate buffering has been reduced: p3a avoids an extra “copy to correlate” buffer in the API layer; however, large JSON still incurs memory overhead due to JSON parsing.
- Practical recommendation: keep responses as small as feasible (especially playlist posts with long `art_url` fields) to avoid heap fragmentation and parse-time allocation spikes.

---

### 1.2 Unified “post” model: artwork posts vs playlist posts

Server now returns a unified `post` object with a **required** `kind` field.

#### `post.kind`

- `"kind": "artwork"` (default if omitted, but server should send explicitly)
- `"kind": "playlist"`

#### Common post fields (both kinds)

p3a expects these in responses where `post` objects appear:

- `post_id` (number)
- `kind` (string)
- `owner_handle` (string)
- `created_at` (string, ISO-8601 UTC)
- `metadata_modified_at` (string, ISO-8601 UTC)

#### Artwork post fields (`kind":"artwork"`)

- `storage_key` (string)
- `art_url` (string)
- `canvas` (string)
- `width` (number)
- `height` (number)
- `frame_count` (number)
- `has_transparency` (bool)
- `artwork_modified_at` (string, ISO-8601 UTC)
- `dwell_time_ms` (number)
  - Interpreted as **artwork dwell time**. (0 means “no override at this level”.)

#### Playlist post fields (`kind":"playlist"`)

- `total_artworks` (number)
- `dwell_time_ms` (number)
  - Interpreted as **playlist dwell time** (default for artworks inside this playlist).
- `artworks` (array)
  - Array entries are playlist artworks (see below)

#### Playlist artwork object fields (inside `post.artworks[]`)

Each element in `artworks[]` is an artwork-like object with at least:

- `post_id` (number)
- `storage_key` (string)
- `art_url` (string)
- `canvas` (string)
- `width` (number)
- `height` (number)
- `frame_count` (number)
- `has_transparency` (bool)
- `owner_handle` (string)
- `created_at` (string, ISO-8601 UTC)
- `metadata_modified_at` (string, ISO-8601 UTC)
- `artwork_modified_at` (string, ISO-8601 UTC)
- `dwell_time_ms` (number)
  - Interpreted as **per-artwork dwell override within the playlist**.

---

### 1.3 Playlist Expansion (PE) support

#### Semantics

- `PE` is an integer in **[0..1023]**.
- `PE = 0` means **“all / infinite”** expansion.
- p3a will **explicitly send `PE: 0`** when configured.

#### p3a defaults

- p3a default `PE` (local) is **8**.
- server default `PE` is **1**.

#### Server expectations

- When `PE` is present in a request:
  - Server should return up to **PE artworks** inside each playlist post’s `artworks[]`.
  - For `PE = 0`, server should return the entire playlist.
    - **Practical requirement**: p3a is designed around `PLAYLIST_MAX_ARTWORKS = 1024`; server should keep `artworks[]` at **<= 1024** items (or implement pagination in the future). Overly large responses are also likely to exceed the MQTT 8KB limit.

---

### 1.4 New MQTT API request: `get_post`

p3a added a dedicated request to fetch a single post by `post_id`.

#### Request publish

Topic:

- `makapix/player/<player_key>/request/<request_id>`

Body:

```json
{
  "request_type": "get_post",
  "post_id": 12345,
  "PE": 8,
  "request_id": "<generated by p3a>",
  "player_key": "<player_key>"
}
```

Notes:

- `PE` is optional.
- If p3a sets playlist expansion to “all”, it will send `"PE": 0` explicitly.

#### Response body

p3a expects:

```json
{
  "request_id": "<same>",
  "success": true,
  "post": {
    "post_id": 12345,
    "kind": "artwork",
    "owner_handle": "...",
    "created_at": "YYYY-MM-DDTHH:MM:SSZ",
    "metadata_modified_at": "YYYY-MM-DDTHH:MM:SSZ",

    "storage_key": "...",
    "art_url": "/.../file.webp",
    "canvas": "...",
    "width": 240,
    "height": 240,
    "frame_count": 1,
    "has_transparency": false,
    "artwork_modified_at": "YYYY-MM-DDTHH:MM:SSZ",
    "dwell_time_ms": 0
  }
}
```

For playlist posts, `post` must match the playlist schema (Section 1.2).

Failure behavior:

- If `success` is false, p3a currently treats this as a generic failure.
- Server may include (optional) error fields:
  - `error` (string)
  - `error_code` (string)

---

### 1.5 Updated MQTT API request: `query_posts` (now supports PE)

p3a uses `query_posts` to get pages of posts for a channel.

#### Request publish

Topic:

- `makapix/player/<player_key>/request/<request_id>`

Body (representative):

```json
{
  "request_type": "query_posts",
  "channel": "all",
  "sort": "server_order",
  "user_handle": "...",
  "cursor": null,
  "limit": 30,
  "random_seed": 123,
  "PE": 8,

  "request_id": "<generated by p3a>",
  "player_key": "<player_key>"
}
```

Rules:

- `channel` is one of:
  - `"all"`, `"promoted"`, `"user"`, `"by_user"`, `"artwork"`
- `sort` is one of:
  - `"server_order"`, `"created_at"`, `"random"`
- `cursor`:
  - if p3a has no cursor, it sends JSON `null`
  - otherwise it sends a string cursor
- `limit`:
  - p3a clamps to **1..50** (default 30)
- `random_seed`:
  - included only when `sort == "random"` and seed is present
- `PE`:
  - included when p3a is configured to send it
  - can be **0** and must be interpreted as “all”

#### Response body

p3a expects:

```json
{
  "request_id": "<same>",
  "success": true,
  "posts": [
    { "post_id": 1, "kind": "artwork", "...": "..." },
    { "post_id": 2, "kind": "playlist", "...": "..." }
  ],
  "has_more": true,
  "next_cursor": "...",
  "error": "...",
  "error_code": "..."
}
```

Notes:

- `posts[]` can contain a mix of artwork and playlist posts.
- p3a currently parses up to **50** posts in a response.

---

### 1.6 Playlist-aware playback expectations (server-facing aspects)

Although most playlist playback logic is local, server payloads are expected to support:

- **Consistent `post_id` identity** for playlists and artworks.
- Correct `kind` string.
- Correct `total_artworks` and `artworks[]` sizing based on `PE`.
- `dwell_time_ms` fields at both playlist and per-artwork levels.

p3a behavior that server should assume:

- p3a will **not stall** if an artwork is not downloaded yet.
- p3a will skip missing items and keep moving forward.
- p3a may request `get_post` for a playlist to fetch the complete artwork list.

---

## Part 2 — Other Makapix Club interactions currently implemented (summary)

### 2.1 HTTPS provisioning

#### POST `https://<CONFIG_MAKAPIX_CLUB_HOST>/api/player/provision`

Request body:

```json
{
  "device_model": "<FW_DEVICE_MODEL>",
  "firmware_version": "<FW_VERSION>"
}
```

Expected response:

- HTTP status: **201**
- JSON body:

```json
{
  "player_key": "<uuid>",
  "registration_code": "<string>",
  "registration_code_expires_at": "<iso8601>",
  "mqtt_broker": { "host": "<string>", "port": 8883 }
}
```

p3a validation:

- Requires `player_key`, `registration_code`, and `mqtt_broker.host` + `.port`.

---

### 2.2 HTTPS credentials polling

#### GET `https://<CONFIG_MAKAPIX_CLUB_HOST>/api/player/<player_key>/credentials`

Expected responses:

- **200** (credentials ready):

```json
{
  "ca_pem": "-----BEGIN CERTIFICATE-----...",
  "cert_pem": "-----BEGIN CERTIFICATE-----...",
  "key_pem": "-----BEGIN PRIVATE KEY-----...",
  "broker": { "host": "<string>", "port": 8883 }
}
```

- **404** (not ready yet): treated as normal “keep polling”.
- **500**: treated as transient; p3a retries.

Notes:

- p3a expects PEM strings to fit in its fixed buffers (order of a few KB each).

---

### 2.3 MQTT connection/authentication and topics

p3a connects using:

- Scheme: `mqtts://<host>:<port>`
- **mTLS**:
  - CA cert for broker verification
  - client cert + client key for device auth
- MQTT username: **`player_key`**
- MQTT password: empty string
- Client ID: `p3a-<player_key>`

Last Will Testament:

- Topic: `makapix/player/<player_key>/status`
- QoS: 1
- Retain: false
- Payload:

```json
{"player_key":"<player_key>","status":"offline"}
```

Subscriptions:

- `makapix/player/<player_key>/command`
- `makapix/player/<player_key>/response/#`

---

### 2.4 MQTT status publish

Topic:

- `makapix/player/<player_key>/status`

QoS:

- 1

Payload:

```json
{
  "player_key": "<player_key>",
  "status": "online",
  "current_post_id": 12345,
  "firmware_version": "<FW_VERSION>",
  "timestamp": "YYYY-MM-DDTHH:MM:SSZ"
}
```

Rules:

- If p3a is playing local-only (e.g., SD content with no Makapix `post_id`), it sends `current_post_id: null`.
- If time is not synchronized, p3a may publish timestamp `1970-01-01T00:00:00Z`.

---

### 2.5 MQTT inbound commands (from server)

Topic:

- `makapix/player/<player_key>/command`

Payload shape:

```json
{
  "command_type": "swap_next",
  "payload": { }
}
```

Supported `command_type` values:

- `swap_next`
- `swap_back`
- `play_channel`
  - payload:

```json
{
  "channel": "all" | "promoted" | "user" | "by_user",
  "user_handle": "<required when channel == by_user>"
}
```

- `show_artwork`
  - payload:

```json
{
  "post_id": 12345,
  "storage_key": "...",
  "art_url": "/.../file.webp"
}
```

Unknown commands are ignored.

---

### 2.6 MQTT API request: `submit_view`

p3a submits view events (currently “fire and forget”, but still requires a parseable response for correlation).

Request publish body:

```json
{
  "request_type": "submit_view",
  "post_id": 12345,
  "view_intent": "automated" | "intentional",

  "request_id": "<generated>",
  "player_key": "<player_key>"
}
```

Response expectation:

- Must include `request_id` and be valid JSON (so the request can complete cleanly).

---

### 2.7 HTTPS artwork download

p3a downloads artwork assets from `art_url`.

Rules:

- If `art_url` begins with `/`, p3a builds the full URL as:
  - `https://<CONFIG_MAKAPIX_CLUB_HOST><art_url>`
- Otherwise p3a treats `art_url` as an absolute URL.

HTTP expectations:

- Server must return **HTTP 200**.
- p3a uses TLS with ESP-IDF certificate bundle.

Filename/type expectations:

- p3a infers the file extension from the URL suffix:
  - `.webp`, `.gif`, `.png`, `.jpg`, `.jpeg`

---

## Notes / practical recommendations to the server team

- Keep MQTT response payloads **< 128KB** (p3a hard limit today).
- Always include `request_id` in responses.
- Always include `kind` in posts (`artwork` or `playlist`).
- When `PE` is provided (including `0`), respect it and keep playlist `artworks[]` sizes bounded (<= 1024 recommended).
