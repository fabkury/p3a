<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>p3a - Settings</title>
<style>
* { box-sizing: border-box; }
body {
    margin: 0;
    padding: 12px 10px 16px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: #fff;
}
@supports (min-height: 100svh) { body { min-height: 100svh; } }
@supports (min-height: 100dvh) { body { min-height: 100dvh; } }
.header {
    text-align: center;
    padding: 8px 0 4px;
    color: white;
}
.header h1 {
    margin: 0;
    font-size: clamp(1.8rem, 4vw, 2.2rem);
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: lowercase;
}
.section {
    width: min(520px, 100%);
    background: rgba(255,255,255,0.95);
    border-radius: 16px;
    padding: 14px;
    margin: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.section h3 {
    margin: 0 0 8px;
    font-size: 0.85rem;
    font-weight: 500;
    color: #333;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.bg-row {
    display: flex;
    gap: 8px;
    align-items: center;
}
.bg-preview {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 2px solid #ddd;
    flex-shrink: 0;
    background: #000;
}
.bg-input {
    width: 100%;
    max-width: 70px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 0.9rem;
}
.bg-save {
    flex: 1 1 auto;
    min-width: 70px;
}
.file-name {
    font-size: 0.75rem;
    color: #555;
    word-break: break-word;
    min-height: 1.2em;
}
.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 0;
}
.toggle-label {
    font-size: 0.9rem;
    color: #333;
}
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 26px;
}
.toggle-slider:before {
    position: absolute;
    content: '';
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}
.toggle-switch input:checked + .toggle-slider {
    background-color: #667eea;
}
.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(22px);
}
.upload-btn {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 9px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}
.upload-btn:active:not(:disabled) {
    background: #45a049;
}
.upload-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.seed-row {
    display: flex;
    gap: 8px;
    align-items: center;
}
.seed-input {
    flex: 1;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 0.9rem;
}
.btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 9px 14px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}
.btn:active:not(:disabled) {
    background: #5568d3;
}
.btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.footer {
    width: min(520px, 100%);
    padding: 8px 0 4px;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}
.footer-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    padding: 7px 14px;
    font-size: 0.85rem;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
}
.footer-btn:active {
    background: rgba(255,255,255,0.3);
}
@media (min-width: 481px) {
    .footer-btn:hover { background: rgba(255,255,255,0.3); }
}
.status {
    position: fixed;
    top: clamp(48px, 12vh, 80px);
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.status.success {
    background: #4CAF50;
    color: white;
}
.status.error {
    background: #f44336;
    color: white;
}
.danger-zone {
    border: 1px solid #e74c3c;
}
.danger-zone h3 {
    color: #c0392b;
}
.danger-btn {
    background: #e74c3c;
    width: 100%;
}
.danger-btn:active:not(:disabled) {
    background: #c0392b;
}
.danger-btn.confirm {
    background: #c0392b;
    animation: pulse 0.5s ease-in-out infinite alternate;
}
@keyframes pulse {
    from { opacity: 1; }
    to { opacity: 0.7; }
}
</style>
</head>
<body>
<div class="header">
    <h1>settings</h1>
</div>
<div class="section">
    <h3>Display</h3>
    <div class="bg-row">
        <div class="bg-preview" id="bg-preview"></div>
        <input class="bg-input" id="bg-r" type="number" min="0" max="255" placeholder="R" oninput="updateColorPreview()">
        <input class="bg-input" id="bg-g" type="number" min="0" max="255" placeholder="G" oninput="updateColorPreview()">
        <input class="bg-input" id="bg-b" type="number" min="0" max="255" placeholder="B" oninput="updateColorPreview()">
        <button class="upload-btn bg-save" id="bg-save" type="button" onclick="saveBackgroundColor()">Save</button>
    </div>
    <div class="file-name" id="bg-hint" style="margin-bottom:8px;">Background color for transparent artwork</div>
    <div class="toggle-row">
        <label for="fps-toggle" class="toggle-label">Show FPS</label>
        <label class="toggle-switch">
            <input type="checkbox" id="fps-toggle" onchange="toggleShowFps(this.checked)">
            <span class="toggle-slider"></span>
        </label>
    </div>
    <div class="toggle-row">
        <label for="maxspeed-toggle" class="toggle-label">Max Speed Playback</label>
        <label class="toggle-switch">
            <input type="checkbox" id="maxspeed-toggle" onchange="toggleMaxSpeedPlayback(this.checked)">
            <span class="toggle-slider"></span>
        </label>
    </div>
    <div class="toggle-row" style="flex-wrap:wrap;gap:8px;">
        <label class="toggle-label">Auto-swap interval</label>
        <div style="display:flex;gap:8px;align-items:center;">
            <input class="bg-input" id="autoswap" type="number" min="0" max="86400" style="max-width:90px;">
            <span style="color:#666;font-size:0.8rem;">sec (0=off)</span>
            <button class="btn" onclick="saveAutoSwap()">Save</button>
        </div>
    </div>
</div>
<div class="section danger-zone">
    <h3>Danger Zone</h3>
    <div class="bg-row">
        <input class="bg-input" id="sd-root" type="text" style="flex:1;max-width:none;" placeholder="/p3a">
        <button class="upload-btn bg-save" id="sd-save" type="button" onclick="saveSdRoot()">Save</button>
    </div>
    <div class="file-name" id="sd-hint" style="margin-bottom:12px;">Storage path on SD card. Reboot required. Existing files will not be moved.</div>
    <button class="btn danger-btn" id="reboot-btn" onclick="reboot()">Reboot</button>
</div>
<div class="section">
    <h3>Global Seed</h3>
    <div class="seed-row">
        <input class="seed-input" id="seed" type="number" min="0" step="1" placeholder="Seed (uint32)">
        <button class="btn" id="seed-save" onclick="saveSeed()">Save</button>
    </div>
    <div class="file-name">Persisted, takes effect after reboot</div>
</div>
<div class="footer">
    <button class="footer-btn" onclick="window.location.href='/'">Home</button>
</div>
<div class="status" id="status"></div>
<script>
function showToast(msg, isError) {
    var status = document.getElementById('status');
    status.textContent = msg;
    status.className = isError ? 'status error' : 'status success';
    status.style.display = 'block';
    setTimeout(function() { status.style.display = 'none'; }, 6000);
}
function clamp255(x) {
    x = parseInt(x, 10);
    if (isNaN(x)) x = 0;
    if (x < 0) x = 0;
    if (x > 255) x = 255;
    return x;
}
function updateColorPreview() {
    var r = clamp255(document.getElementById('bg-r').value);
    var g = clamp255(document.getElementById('bg-g').value);
    var b = clamp255(document.getElementById('bg-b').value);
    document.getElementById('bg-preview').style.background = 'rgb(' + r + ',' + g + ',' + b + ')';
}
function loadBackgroundColor() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/config', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                var resp = JSON.parse(xhr.responseText || '{}');
                var cfg = (resp && resp.ok && resp.data) ? resp.data : {};
                var bg = (cfg && cfg.background_color) ? cfg.background_color : null;
                var r = bg && typeof bg.r === 'number' ? bg.r : 0;
                var g = bg && typeof bg.g === 'number' ? bg.g : 0;
                var b = bg && typeof bg.b === 'number' ? bg.b : 0;
                document.getElementById('bg-r').value = clamp255(r);
                document.getElementById('bg-g').value = clamp255(g);
                document.getElementById('bg-b').value = clamp255(b);
                updateColorPreview();
            } catch (e) {
                document.getElementById('bg-r').value = 0;
                document.getElementById('bg-g').value = 0;
                document.getElementById('bg-b').value = 0;
                updateColorPreview();
            }
        }
    };
    xhr.send();
}
function saveBackgroundColor() {
    var btn = document.getElementById('bg-save');
    btn.disabled = true;
    var r = clamp255(document.getElementById('bg-r').value);
    var g = clamp255(document.getElementById('bg-g').value);
    var b = clamp255(document.getElementById('bg-b').value);
    var xhrGet = new XMLHttpRequest();
    xhrGet.open('GET', '/config', true);
    xhrGet.onreadystatechange = function() {
        if (xhrGet.readyState === 4) {
            var cfg = {};
            try {
                var resp = JSON.parse(xhrGet.responseText || '{}');
                cfg = (resp && resp.ok && resp.data) ? resp.data : {};
            } catch (e) { cfg = {}; }
            cfg.background_color = { r: r, g: g, b: b };
            var xhrPut = new XMLHttpRequest();
            xhrPut.open('PUT', '/config', true);
            xhrPut.setRequestHeader('Content-Type', 'application/json');
            xhrPut.onreadystatechange = function() {
                if (xhrPut.readyState === 4) {
                    btn.disabled = false;
                    if (xhrPut.status >= 200 && xhrPut.status < 300) {
                        showToast('Background saved', false);
                    } else {
                        showToast('Save failed (HTTP ' + xhrPut.status + ')', true);
                    }
                }
            };
            xhrPut.send(JSON.stringify(cfg));
        }
    };
    xhrGet.send();
}
function loadShowFps() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/config', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                var resp = JSON.parse(xhr.responseText || '{}');
                var cfg = (resp && resp.ok && resp.data) ? resp.data : {};
                var showFps = (typeof cfg.show_fps === 'boolean') ? cfg.show_fps : true;
                document.getElementById('fps-toggle').checked = showFps;
            } catch (e) {
                document.getElementById('fps-toggle').checked = true;
            }
        }
    };
    xhr.send();
}
function toggleShowFps(enable) {
    var xhrGet = new XMLHttpRequest();
    xhrGet.open('GET', '/config', true);
    xhrGet.onreadystatechange = function() {
        if (xhrGet.readyState === 4) {
            var cfg = {};
            try {
                var resp = JSON.parse(xhrGet.responseText || '{}');
                cfg = (resp && resp.ok && resp.data) ? resp.data : {};
            } catch (e) { cfg = {}; }
            cfg.show_fps = enable;
            var xhrPut = new XMLHttpRequest();
            xhrPut.open('PUT', '/config', true);
            xhrPut.setRequestHeader('Content-Type', 'application/json');
            xhrPut.onreadystatechange = function() {
                if (xhrPut.readyState === 4) {
                    if (xhrPut.status >= 200 && xhrPut.status < 300) {
                        showToast('FPS display ' + (enable ? 'enabled' : 'disabled'), false);
                    } else {
                        showToast('Save failed (HTTP ' + xhrPut.status + ')', true);
                        document.getElementById('fps-toggle').checked = !enable;
                    }
                }
            };
            xhrPut.send(JSON.stringify(cfg));
        }
    };
    xhrGet.send();
}
function loadMaxSpeedPlayback() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/config', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                var resp = JSON.parse(xhr.responseText || '{}');
                var cfg = (resp && resp.ok && resp.data) ? resp.data : {};
                var maxSpeed = (typeof cfg.max_speed_playback === 'boolean') ? cfg.max_speed_playback : false;
                document.getElementById('maxspeed-toggle').checked = maxSpeed;
            } catch (e) {
                document.getElementById('maxspeed-toggle').checked = false;
            }
        }
    };
    xhr.send();
}
function toggleMaxSpeedPlayback(enable) {
    var xhrGet = new XMLHttpRequest();
    xhrGet.open('GET', '/config', true);
    xhrGet.onreadystatechange = function() {
        if (xhrGet.readyState === 4) {
            var cfg = {};
            try {
                var resp = JSON.parse(xhrGet.responseText || '{}');
                cfg = (resp && resp.ok && resp.data) ? resp.data : {};
            } catch (e) { cfg = {}; }
            cfg.max_speed_playback = enable;
            var xhrPut = new XMLHttpRequest();
            xhrPut.open('PUT', '/config', true);
            xhrPut.setRequestHeader('Content-Type', 'application/json');
            xhrPut.onreadystatechange = function() {
                if (xhrPut.readyState === 4) {
                    if (xhrPut.status >= 200 && xhrPut.status < 300) {
                        showToast('Max speed playback ' + (enable ? 'enabled' : 'disabled'), false);
                    } else {
                        showToast('Save failed (HTTP ' + xhrPut.status + ')', true);
                        document.getElementById('maxspeed-toggle').checked = !enable;
                    }
                }
            };
            xhrPut.send(JSON.stringify(cfg));
        }
    };
    xhrGet.send();
}
function loadSdRoot() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/config', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                var resp = JSON.parse(xhr.responseText || '{}');
                var cfg = (resp && resp.ok && resp.data) ? resp.data : {};
                var sdRoot = cfg.sdcard_root || '/p3a';
                document.getElementById('sd-root').value = sdRoot;
            } catch (e) {
                document.getElementById('sd-root').value = '/p3a';
            }
        }
    };
    xhr.send();
}
function saveSdRoot() {
    var btn = document.getElementById('sd-save');
    btn.disabled = true;
    var sdRoot = document.getElementById('sd-root').value.trim();
    if (!sdRoot || sdRoot.length === 0) {
        showToast('Path cannot be empty', true);
        btn.disabled = false;
        return;
    }
    if (!sdRoot.startsWith('/')) {
        showToast('Path must start with /', true);
        btn.disabled = false;
        return;
    }
    if (sdRoot === '/') {
        showToast('Path cannot be just / - specify a folder', true);
        btn.disabled = false;
        return;
    }
    if (sdRoot.includes('..')) {
        showToast('Path cannot contain ..', true);
        btn.disabled = false;
        return;
    }
    var xhrGet = new XMLHttpRequest();
    xhrGet.open('GET', '/config', true);
    xhrGet.onreadystatechange = function() {
        if (xhrGet.readyState === 4) {
            var cfg = {};
            try {
                var resp = JSON.parse(xhrGet.responseText || '{}');
                cfg = (resp && resp.ok && resp.data) ? resp.data : {};
            } catch (e) { cfg = {}; }
            cfg.sdcard_root = sdRoot;
            var xhrPut = new XMLHttpRequest();
            xhrPut.open('PUT', '/config', true);
            xhrPut.setRequestHeader('Content-Type', 'application/json');
            xhrPut.onreadystatechange = function() {
                if (xhrPut.readyState === 4) {
                    btn.disabled = false;
                    if (xhrPut.status >= 200 && xhrPut.status < 300) {
                        showToast('Root path saved - reboot required', false);
                    } else {
                        showToast('Save failed (HTTP ' + xhrPut.status + ')', true);
                    }
                }
            };
            xhrPut.send(JSON.stringify(cfg));
        }
    };
    xhrGet.send();
}
function loadSeed() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/settings/global_seed', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                var r = JSON.parse(xhr.responseText);
                if (xhr.status >= 200 && xhr.status < 300 && r.ok) {
                    document.getElementById('seed').value = r.data.global_seed;
                } else {
                    showToast('Failed to load seed', true);
                }
            } catch (e) {
                showToast('Parse error', true);
            }
        }
    };
    xhr.send();
}
function saveSeed() {
    var btn = document.getElementById('seed-save');
    btn.disabled = true;
    var v = document.getElementById('seed').value;
    var n = parseInt(v, 10);
    if (isNaN(n) || n < 0) {
        showToast('Invalid seed', true);
        btn.disabled = false;
        return;
    }
    var xhr = new XMLHttpRequest();
    xhr.open('PUT', '/settings/global_seed', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            btn.disabled = false;
            try {
                var r = JSON.parse(xhr.responseText);
                if (xhr.status >= 200 && xhr.status < 300 && r.ok) {
                    showToast('Saved. Reboot to apply.', false);
                } else {
                    showToast('Save failed', true);
                }
            } catch (e) {
                showToast('Parse error', true);
            }
        }
    };
    xhr.send(JSON.stringify({global_seed: n}));
}
function loadAutoSwap() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/config', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try {
                var resp = JSON.parse(xhr.responseText || '{}');
                var cfg = (resp && resp.ok && resp.data) ? resp.data : {};
                var ms = (typeof cfg.dwell_time_ms === 'number') ? cfg.dwell_time_ms : 30000;
                document.getElementById('autoswap').value = Math.floor(ms / 1000);
            } catch (e) {
                document.getElementById('autoswap').value = 30;
            }
        }
    };
    xhr.send();
}
function saveAutoSwap() {
    var sec = parseInt(document.getElementById('autoswap').value, 10);
    if (isNaN(sec) || sec < 0) sec = 0;
    if (sec > 86400) sec = 86400;
    if (sec > 0 && sec < 5) {
        showToast('Minimum is 5 seconds', true);
        return;
    }
    var xhrGet = new XMLHttpRequest();
    xhrGet.open('GET', '/config', true);
    xhrGet.onreadystatechange = function() {
        if (xhrGet.readyState === 4) {
            var cfg = {};
            try {
                var resp = JSON.parse(xhrGet.responseText || '{}');
                cfg = (resp && resp.ok && resp.data) ? resp.data : {};
            } catch (e) { cfg = {}; }
            cfg.dwell_time_ms = sec * 1000;
            var xhrPut = new XMLHttpRequest();
            xhrPut.open('PUT', '/config', true);
            xhrPut.setRequestHeader('Content-Type', 'application/json');
            xhrPut.onreadystatechange = function() {
                if (xhrPut.readyState === 4) {
                    if (xhrPut.status >= 200 && xhrPut.status < 300) {
                        showToast(sec === 0 ? 'Auto-swap disabled' : 'Auto-swap: ' + sec + 's', false);
                    } else {
                        showToast('Save failed', true);
                    }
                }
            };
            xhrPut.send(JSON.stringify(cfg));
        }
    };
    xhrGet.send();
}
var rebootPending = false;
var rebootTimeout = null;
function reboot() {
    var btn = document.getElementById('reboot-btn');
    if (!rebootPending) {
        rebootPending = true;
        btn.textContent = 'Click again to confirm';
        btn.classList.add('confirm');
        rebootTimeout = setTimeout(function() {
            rebootPending = false;
            btn.textContent = 'Reboot';
            btn.classList.remove('confirm');
        }, 2000);
    } else {
        clearTimeout(rebootTimeout);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/action/reboot', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send('{}');
        showToast('Reboot queued', false);
        rebootPending = false;
        btn.textContent = 'Reboot';
        btn.classList.remove('confirm');
    }
}
loadBackgroundColor();
loadShowFps();
loadMaxSpeedPlayback();
loadAutoSwap();
loadSdRoot();
loadSeed();
</script>
</body>
</html>
